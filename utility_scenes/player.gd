extends Node2D


# Declare member variables here. Examples:
# var a = 2
# var b = "text"
export var MAX_ORBIT_VELOCITY = 2
export var ORBITAL_ACCEL = 0.05
export var BULLET_COOLDOWN = 0.05

var time_begin
var time_delay
var time_stamps = [1.893900, 3.500680, 3.959456, 4.418231, 6.039048, 6.495147, 7.407347, 8.103492, 8.557869, 9.149841, 9.603786, 10.057710, 10.422517, 10.876327, 11.330113, 11.783900, 12.258799, 12.599592, 13.281157, 13.743696, 14.081904, 14.420091, 14.758299, 15.144966, 15.483401, 15.821836, 16.160273, 16.416576, 16.755033, 17.093493, 17.431950, 17.770432, 18.488548, 18.944241, 19.413786, 19.867483, 20.321156, 20.774853, 21.474670, 21.928253, 22.411587, 22.865126, 23.318686, 23.915215, 24.368685, 24.822132, 25.408390, 25.862131, 26.315895, 26.798550, 27.252176, 27.705805, 28.159433, 28.643221, 29.096689, 29.550159, 32.132881, 32.586281, 33.560024, 34.013924, 34.419434, 34.873154, 35.326847, 35.800114, 36.253017, 36.705940, 37.412720, 37.865261, 38.317780, 38.799976, 39.251541, 39.703106, 40.550999, 41.001156, 41.451294, 42.029160, 42.479546, 42.929955, 43.641994, 44.096893, 44.551815, 45.248142, 45.699593, 46.490112, 46.941860, 47.393627, 48.021564, 48.472767, 48.923992, 49.399502, 49.850384, 50.301270, 50.786442, 51.239117, 51.691814, 52.175285, 52.628460, 53.081654, 53.558300, 54.011631, 54.464989, 54.918324, 55.403900, 55.857437, 56.310997, 56.789841, 57.243221, 57.696598, 58.176666, 58.630272, 59.083878, 59.561790, 60.015442, 60.469093, 61.359638, 61.813354, 62.267052, 62.828163, 63.281315, 63.734489, 64.178185, 64.630661, 65.083130, 65.799385, 66.252220, 66.705032, 67.297028, 67.749725, 68.202400, 68.677116, 69.130524, 69.583923, 70.070656, 70.523743, 70.976799, 71.454826, 71.907959, 72.361092, 73.056511, 73.510139, 73.963760, 74.716759, 75.169907, 75.623085, 76.064262, 76.517754, 76.971245, 77.455849, 77.908890, 78.839752, 79.292900, 79.746078, 80.199249, 80.568817, 81.022385, 81.475945, 81.953903, 82.407166, 82.860451, 83.336143, 83.789482, 84.242813, 84.849251, 85.302223, 85.755196, 86.224014, 86.677055, 87.130066, 87.583107, 87.952423, 88.405945, 88.859459, 89.565643, 90.018913, 90.472198, 90.831856, 91.285217, 91.738548, 92.224396, 92.677139, 93.129906, 93.582657, 93.950340, 94.403198, 94.856056, 95.521881, 95.975082, 96.428253, 96.835785, 97.288956, 97.742134, 98.218117, 98.671471, 99.124832, 99.605423, 100.058846, 100.512291, 100.965714, 101.450996, 101.904556, 102.358116, 102.851768, 103.306190, 103.760612, 104.226715, 104.680794, 105.134895, 105.605782, 106.059341, 106.512878, 106.966438, 107.332039, 107.785240, 108.238434, 108.896210, 109.349205, 109.802223, 111.723518, 114.009323, 114.485420, 115.847145, 116.333267, 116.787643, 117.723763, 118.631630, 119.108505, 119.562111, 120.015739, 120.487846, 120.828659, 121.169479, 121.510269, 121.981613, 122.320045, 122.658501, 122.996941, 123.370659, 123.709366, 124.048096, 124.386826, 124.725533, 125.111137, 125.566872, 126.022583, 126.492226, 126.946487, 127.400726, 127.872993, 128.327072, 128.781174, 129.235260, 129.719574, 130.173630, 130.627716, 131.100250, 131.554199, 132.008148, 132.483780, 132.937943, 133.392105, 133.873810, 134.327866, 134.781952, 135.255417, 135.709412, 136.163406, 136.617371, 139.143509, 139.597488, 140.583649, 141.037842, 141.492172, 141.945374, 142.398544, 142.876236, 143.327072, 143.777908, 144.488678, 144.938187, 145.387711, 146.052444, 146.501785, 146.951141, 147.540039, 147.995987, 148.451904, 149.022171, 149.470322, 149.918442, 150.257736, 150.705948, 151.154144, 152.003830, 152.451004, 152.898193, 153.479462, 153.927094, 154.374756, 154.965607, 155.413315, 155.860992, 156.466797, 156.916260, 157.365692, 157.868958, 158.319641, 158.770325, 159.253250, 159.705017, 160.156799, 160.918457, 161.370438, 161.822403, 162.475235, 162.927643, 163.380020, 164.087997, 164.539932, 165.023895, 165.476013, 165.928101, 166.380203, 167.089142, 167.541534, 168.349884, 168.802353, 169.254852, 169.836197, 170.288803, 170.741409, 171.148865, 171.600952, 172.053009, 172.645325, 173.097580, 173.549820, 174.293854, 174.746170, 175.198486, 175.644485, 176.097580, 176.550659, 177.150955, 177.604111, 178.057251, 178.532578, 178.985809, 179.439026, 180.029907, 180.483383, 180.936829, 181.714447, 182.167694, 182.620911, 183.031433, 183.484879, 183.938324, 184.686325, 185.139435, 185.592514, 186.030151, 186.483170, 186.936218, 187.408981, 187.862564, 188.316147, 189.162003, 189.615448, 190.068863, 190.524338, 190.977692, 191.431046, 191.919159, 192.372238, 192.825333, 193.298904, 193.751953, 194.204987, 194.658020, 195.030869, 195.484146, 195.937454, 196.574814, 197.027817, 197.480865, 197.910675, 198.364120, 198.817551, 199.302109, 199.755234, 200.208374, 200.686401, 201.139389, 201.592377, 202.045380, 202.635757, 203.089020, 203.542297, 204.063522, 204.516693, 204.969879, 205.294144, 205.747299, 206.200455, 206.688324, 207.141220, 207.594101, 208.172638, 208.625580, 209.078506, 209.798569, 210.254333, 210.710098, 211.176514, 211.629974, 212.083450, 212.565643, 213.019501, 213.473373, 213.927231, 214.455231]
var stamp_ind = 0

var bullet_time = 0
var orbit_velocity = 0
var bullet = preload("res://utility_scenes/bullet.tscn")

# Called when the node enters the scene tree for the first time.
func _ready():
	time_begin = OS.get_ticks_usec()
	time_delay = AudioServer.get_output_latency()
	pass # Replace with function body.

func _process(delta):
	
	### TEST CODE
	
	if(Input.is_action_just_pressed("ui_down")):
		GameState.start_collect_mode()
	elif(Input.is_action_just_pressed("ui_up")):
		GameState.start_shoot_mode()
	
	### TEST CODE ENDS
	if(Input.is_action_pressed("left")):
		orbit_velocity = lerp(orbit_velocity, MAX_ORBIT_VELOCITY, ORBITAL_ACCEL)
	elif(Input.is_action_pressed("right")):
		orbit_velocity = lerp(orbit_velocity, -MAX_ORBIT_VELOCITY, ORBITAL_ACCEL)
	else:
		orbit_velocity = lerp(orbit_velocity, 0, ORBITAL_ACCEL)
	rotate(orbit_velocity*delta)
	
func _physics_process(delta):
	var time = (OS.get_ticks_usec() - time_begin) / 1000000.0
	# Compensate for latency.
	time -= (time_delay + 1)
	# May be below 0 (did not begin yet).
	time = max(0, time)
	get_parent().get_node("Circle").visible = false
	if(stamp_ind < time_stamps.size() && time_stamps[stamp_ind] < time):
		get_parent().get_node("Circle").visible = true
		stamp_ind += 1
		var b = bullet.instance()
		b.position = $Player_motif.global_position
		b.rotation = rotation
		b.velocity = (global_position - $Player_motif.global_position)*2.5
		get_parent().add_child(b)
# Called every frame. 'delta' is the elapsed time since the previous frame.
func player_hit():
	print("lagi")
#	pass
