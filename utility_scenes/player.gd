extends Node2D


# Declare member variables here. Examples:
# var a = 2
# var b = "text"
export var MAX_ORBIT_VELOCITY = 2
export var ORBITAL_ACCEL = 0.05
export var BULLET_COOLDOWN = 0.05

var time_begin
var time_delay
var time_stamps = [3.614021,4.103854,4.593688,5.083521,5.646438,6.041458,6.436479,6.831500,7.226521,7.621542,8.016562,8.447333,8.842146,9.236938,9.631750,10.026542,10.421354,10.816146,11.243208,11.637834,12.032479,12.427104,12.821750,13.216375,13.611000,14.038771,14.433437,14.828104,15.222771,15.617437,16.012104,16.436230,16.830250,17.224272,17.618292,18.012333,18.406355,18.800375,19.231916,19.625813,20.019730,20.413647,20.807562,21.201458,21.595375,22.036104,22.429958,22.823812,23.217667,23.611521,24.005375,24.399229,24.837917,25.231667,25.625437,26.019188,26.412958,26.806707,27.200480,27.636396,28.030312,28.424208,28.818125,29.212042,29.605938,29.999855,30.244854,30.638916,31.032980,31.427042,31.821104,32.215168,32.609230,33.031166,33.425415,33.819687,34.213959,34.608208,35.002480,35.396751,35.829166,36.223331,36.617500,37.011665,37.405853,37.800022,38.194187,38.542957,38.937187,39.331417,39.725647,40.119877,40.514126,40.908356,41.332874,41.727085,42.121292,42.515499,42.909710,43.303917,43.833061,44.227207,44.621376,45.015541,45.409687,45.803856,46.198002,46.631439,47.025646,47.419834,47.814022,48.208210,48.602394,48.996582,49.430458,49.824604,50.218769,50.612915,51.007084,51.401230,51.795395,52.231457,52.625710,53.019958,53.414207,53.808460,54.202709,54.596958,54.842522,55.236813,55.631126,56.025436,56.419750,56.814064,57.208374,58.024311,58.418541,58.812790,59.207020,59.601273,59.995499,61.216438,61.610645,62.004852,62.399082,62.793293,63.236584,63.630875,64.419456,64.813728,65.208023,65.630959,66.025040,66.419128,67.207291,67.601357,67.995438,68.429352,68.823189,69.217003,69.610832,70.004669,70.398499,70.792336,71.225021,71.619019,72.013039,72.407043,72.801041,73.195061,73.589066,74.025604,74.419647,74.813690,75.207726,75.601768,75.995811,76.389854,76.831413,77.225502,77.619583,78.013664,78.407768,78.801857,79.229462,79.623566,80.017647,80.411751,80.805832,81.199936,81.594017,82.026253,82.420334,82.814415,83.208481,83.602562,83.996628,84.390709,84.827667,85.221664,85.615685,86.009705,86.403732,86.797729,87.191750,87.629982,88.023979,88.417961,88.811958,89.205940,89.599937,89.993919,90.428207,90.822289,91.216377,91.610458,92.004539,92.398628,92.792709,93.215477,93.609642,94.003792,94.397957,94.792107,95.186249,95.626686,96.020790,96.414894,96.808998,97.203102,97.597206,97.991310,98.425163,98.819229,99.213295,99.607353,100.001396,100.395462,100.789520,101.226021,101.620125,102.014206,102.408310,102.802414,103.196518,103.590622,104.025940,104.420059,104.814186,105.208313,105.602455,105.996582,106.390709,106.827934,107.222023,107.616104,108.010185,108.404274,108.798355,109.192436,109.434273,109.828293,110.222313,110.616333,111.010353,111.404373,111.798416,112.236168,112.630211,113.024246,113.418289,113.812332,114.206375,114.600418,115.431877,115.825958,116.220039,116.614128,117.008209,117.402313,117.647644,118.041832,118.435997,118.830185,119.224358,119.618538,120.012711,120.441292,120.835480,121.229691,121.623894,122.018082,122.412292,122.806503,123.242188,123.636436,124.030685,124.424934,124.819206,125.213455,125.639252,126.033646,126.428040,126.822456,127.216858,127.611252,128.005646,128.435287,128.829956,129.224609,129.619247,130.013901,130.408539,130.803207,131.235687,131.630112,132.024521,132.418930,132.813339,133.207748,133.602173,134.028564,134.422546,134.816498,135.210480,135.604462,135.998444,136.392410,136.835358,137.229355,138.017334,138.411316,138.805313,139.199295,139.636566,140.030441,140.424332,140.818207,141.212097,141.605972,142.007965,142.401840,142.795715,143.189590,143.977341,144.371216,144.741043,145.135284,145.529556,145.923813,146.318085,146.712326,147.106598,147.833786,148.227921,148.622055,149.016205,149.410355,149.804504,150.235062,150.629166,151.023270,151.417374,151.811478,152.205582,152.599686,152.944153,153.338181,153.732208,154.126251,154.520294,154.914337,155.308380,155.643417,156.037476,156.431549,156.825607,157.219666,157.613724,158.007797,158.431686,158.825806,159.219940,159.614090,160.008209,160.402328,160.796463,161.229187,161.623352,162.017517,162.411682,162.805832,163.199997,163.594162,164.026978,164.421082,164.815186,165.209290,165.603378,165.997482,166.391586,166.832184,167.226288,167.620422,168.014526,168.408630,168.802734,169.196838,169.628860,170.022934,170.417023,170.811081,171.205170,171.599243,171.993332,172.240128,172.634140,173.028152,173.422165,173.816193,174.210190,174.604202,175.031189,175.425201,175.819244,176.213287,176.607330,177.001373,177.395416,177.830078,178.224167,178.618256,179.012329,179.406418,179.800507,180.194580,180.443069,180.837143,181.231232,181.625305,182.019394,182.413483,182.807556,183.227982,183.622055,184.016159,184.410278,184.804352,185.198456,186.027481,186.421600,186.815735,187.209869,187.604004,187.998123,188.392242,188.645065,189.039169,189.433273,189.827377,190.221481,190.615570,191.009674,191.435150,191.829224,192.223312,192.617401,193.011475,193.405563,193.799652,194.425919,194.819977,195.214035,196.002167,196.833252,197.227402,197.621536,198.409836,198.803986,199.198120,199.636292,200.030350,202.434692,202.828918,203.223145,203.617371,204.011597,204.834045,205.227997,205.621979]
var stamp_ind = 0

var bullet_time = 0
var orbit_velocity = 0
var bullet = preload("res://utility_scenes/bullet.tscn")

# Called when the node enters the scene tree for the first time.
func _ready():
	time_begin = OS.get_ticks_usec()
	time_delay = AudioServer.get_time_to_next_mix() + AudioServer.get_output_latency()
	get_parent().get_node("AudioStreamPlayer").play()
	pass # Replace with function body.

func _process(delta):
	
	### TEST CODE
	
	if(Input.is_action_just_pressed("ui_down")):
		GameState.start_collect_mode()
	elif(Input.is_action_just_pressed("ui_up")):
		GameState.start_shoot_mode()
	
	### TEST CODE ENDS
	if(Input.is_action_pressed("left")):
		orbit_velocity = lerp(orbit_velocity, MAX_ORBIT_VELOCITY, ORBITAL_ACCEL)
	elif(Input.is_action_pressed("right")):
		orbit_velocity = lerp(orbit_velocity, -MAX_ORBIT_VELOCITY, ORBITAL_ACCEL)
	else:
		orbit_velocity = lerp(orbit_velocity, 0, ORBITAL_ACCEL)
	rotate(orbit_velocity*delta)
	
func _physics_process(delta):
	
	var time = (OS.get_ticks_usec() - time_begin) / 1000000.0
	# Compensate for latency.
	time -= time_delay
	# May be below 0 (did not begin yet).
	time = max(0, time)
	get_parent().get_node("Circle").visible = false
	if(stamp_ind < time_stamps.size() && time_stamps[stamp_ind] < time):
		get_parent().get_node("Circle").visible = true
		stamp_ind += 1
		var b = bullet.instance()
		b.position = $Player_motif.global_position
		b.rotation = rotation
		b.velocity = (global_position - $Player_motif.global_position)*2.5
		get_parent().add_child(b)
# Called every frame. 'delta' is the elapsed time since the previous frame.
func player_hit():
	print("lagi")
#	pass
