extends Node2D


# Declare member variables here. Examples:
# var a = 2
# var b = "text"
export var MAX_ORBIT_VELOCITY = 2
export var ORBITAL_ACCEL = 0.05
export var BULLET_COOLDOWN = 0.05

var time_begin
var time_delay
var time_stamps = [2.870687,3.216417,3.562146,3.907875,4.599333,4.945063,5.290792,6.017833,6.479354,6.940875,7.402396,7.863896,8.492604,8.955063,9.417500,9.879958,10.342417,10.804854,11.350958,11.813105,12.275250,12.737396,13.199542,14.079729,14.540916,15.002125,15.463312,15.924520,16.443624,16.900791,17.357958,17.815104,18.272270,18.729437,19.149271,19.609104,20.068958,20.528812,20.988667,21.448521,21.964312,22.424854,22.885395,23.345938,23.806479,24.267042,24.762896,25.223875,25.684875,26.145855,27.067833,27.579813,28.040958,28.502104,28.963249,29.424397,30.397959,30.858978,31.320021,31.781042,32.242062,32.703106,33.207939,33.669209,34.130478,34.591751,35.053020,35.547707,36.009209,36.470688,36.932186,37.393688,37.855167,38.360958,38.822521,39.284103,39.745667,40.207230,40.668793,41.174793,41.636436,42.098083,42.559708,43.021355,43.483002,43.987415,44.449085,44.910751,45.372437,45.834103,46.295773,46.785084,47.246498,47.707939,48.169353,48.630791,49.092228,49.503582,49.965103,50.426647,50.888168,51.349686,51.811230,52.189686,52.651333,53.112980,53.574623,54.036270,54.497894,54.983978,55.445564,55.907166,56.368771,56.830353,57.291958,57.784355,58.246063,58.707748,59.169437,59.631145,60.142082,60.603748,61.065395,61.527061,61.988708,62.450375,62.959126,63.420834,63.882542,64.344254,64.805962,65.267670,65.770691,66.232498,66.694313,67.156143,67.617958,68.079773,68.583878,69.045540,69.507233,69.968918,70.430580,70.892273,71.392456,71.854080,72.315727,72.777351,73.238976,73.700607,74.116837,74.578438,75.040024,75.501625,75.963226,76.424812,76.834274,77.296684,77.759125,78.221565,78.683983,79.146416,79.630707,80.093414,80.556122,81.018837,81.481544,81.977646,82.440231,82.902794,83.365372,83.827934,84.290520,84.786705,85.249168,85.711624,86.174080,86.636543,87.098999,87.601585,88.063210,88.524834,88.986481,89.448105,89.909729,90.414627,90.876312,91.338020,91.799706,92.261398,92.723083,93.206482,93.667419,94.128334,94.589249,95.050163,95.511101,96.012955,96.473915,96.934875,97.395851,97.856812,98.350357,98.810982,99.271606,99.732231,100.192856,100.653481,101.154854,101.616211,102.077545,102.538895,103.000252,103.461601,103.982712,104.444374,104.906044,105.367706,105.829376,106.291039,106.785271,107.246483,107.707710,108.168915,108.630127,109.091354,109.603935,110.065269,110.526627,110.987961,111.449295,111.910622,112.352127,112.813667,113.275230,113.736794,114.198334,114.659897,115.006561,115.468018,115.929482,116.390938,116.852394,117.313850,117.797211,118.258835,118.720436,119.182060,119.643684,120.105293,120.403374,120.864830,121.326309,121.787788,122.249268,122.710747,123.204750,123.666252,124.127747,124.589249,125.050774,125.512268,126.016541,126.478226,126.939919,127.401581,127.863274,128.324936,129.048462,129.509827,129.971191,130.432556,130.893921,131.392410,131.853836,132.315231,132.776642,133.238068,133.699463,134.194534,134.656143,135.117767,135.579376,136.041000,136.502609,136.830917,137.293396,137.755875,138.218353,138.680832,139.143326,139.628937,140.091431,140.553909,141.016403,141.478882,141.941360,142.376129,142.838745,143.301361,143.763977,144.226608,144.689209,145.140854,145.603287,146.065704,146.528152,146.990585,147.493561,147.955276,148.416962,148.878647,149.340332,149.802017,150.329224,150.790848,151.252457,151.714066,152.175659,152.637268,153.101868,153.563080,154.024292,154.485504,154.946701,155.407913,155.785965,156.247192,156.708389,157.169632,157.630829,158.092056,158.584122,159.045166,159.506195,159.967224,160.428268,160.889297,161.398438,161.860062,162.321701,162.783340,163.244965,163.706589,164.212769,164.674316,165.135880,165.597412,166.058960,166.520523,167.004715,167.465714,167.926712,168.387726,168.848724,169.348038,169.809235,170.270416,170.731628,171.192810,171.654007,172.156296,172.617432,173.078583,173.539734,174.000870,174.462021,174.963547,175.424622,175.885727,176.346817,176.807922,177.268997,177.780060,178.703522,179.165222,179.626953,180.088684,180.597443,181.059067,181.520691,181.982315,182.443939,182.905563,183.638351,184.561890,185.023651,185.485413,185.989975,186.451767,186.913544,187.375336,187.837097,188.298889,189.024994,189.486786,189.948578,190.410370,190.872162,191.376007,191.834900,192.293793,192.752686,193.211578,193.670486,194.298767]
var stamp_ind = 0

var bullet_time = 0
var orbit_velocity = 0
var bullet = preload("res://utility_scenes/bullet.tscn")

# Called when the node enters the scene tree for the first time.
func _ready():
	time_begin = OS.get_ticks_usec()
	time_delay = AudioServer.get_time_to_next_mix() + AudioServer.get_output_latency()
	get_parent().get_node("AudioStreamPlayer").play()
	pass # Replace with function body.

func _process(delta):
	
	### TEST CODE
	
	if(Input.is_action_just_pressed("ui_down")):
		GameState.start_collect_mode()
	elif(Input.is_action_just_pressed("ui_up")):
		GameState.start_shoot_mode()
	
	### TEST CODE ENDS
	if(Input.is_action_pressed("left")):
		orbit_velocity = lerp(orbit_velocity, MAX_ORBIT_VELOCITY, ORBITAL_ACCEL)
	elif(Input.is_action_pressed("right")):
		orbit_velocity = lerp(orbit_velocity, -MAX_ORBIT_VELOCITY, ORBITAL_ACCEL)
	else:
		orbit_velocity = lerp(orbit_velocity, 0, ORBITAL_ACCEL)
	rotate(orbit_velocity*delta)
	
func _physics_process(delta):
	
	var time = (OS.get_ticks_usec() - time_begin) / 1000000.0
	# Compensate for latency.
	time -= time_delay
	# May be below 0 (did not begin yet).
	time = max(0, time)
	get_parent().get_node("Circle").visible = false
	if(stamp_ind < time_stamps.size() && time_stamps[stamp_ind] < time):
		get_parent().get_node("Circle").visible = true
		stamp_ind += 1
		var b = bullet.instance()
		b.position = $Player_motif.global_position
		b.rotation = rotation
		b.velocity = (global_position - $Player_motif.global_position)*2.5
		get_parent().add_child(b)
# Called every frame. 'delta' is the elapsed time since the previous frame.
func player_hit():
	print("lagi")
#	pass
